name: ðŸ¤– Auto-Generate K8s Manifests

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    paths:
      - 'services/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/**'
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Service name to generate manifests for'
        required: false
        type: string
      port:
        description: 'Service port (default: 5000)'
        required: false
        default: '5000'
        type: string
      replicas:
        description: 'Number of replicas (default: 2)'
        required: false
        default: '2'
        type: string

jobs:
  detect-new-services:
    name: ðŸ” Detect New Services
    runs-on: ubuntu-latest
    outputs:
      new_services: ${{ steps.detect.outputs.new_services }}
      has_new_services: ${{ steps.detect.outputs.has_new_services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect new services
        id: detect
        run: |
          echo "ðŸ” Checking for new services..."
          
          # Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼
          if [ -n "${{ github.event.inputs.service_name }}" ]; then
            SERVICE_NAME="${{ github.event.inputs.service_name }}"
            echo "ðŸ“¦ Manual trigger for service: $SERVICE_NAME"
            echo "new_services=[\"$SERVICE_NAME\"]" >> $GITHUB_OUTPUT
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          NEW_SERVICES=""
          
          # ÐÐ°Ð¹Ñ‚Ð¸ Ð²ÑÐµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          for service_dir in services/*/; do
            if [ ! -d "$service_dir" ]; then
              continue
            fi
            
            service_name=$(basename "$service_dir")
            
            # ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ app.py Ð¸Ð»Ð¸ Dockerfile
            if [ ! -f "$service_dir/app.py" ] && [ ! -f "$service_dir/Dockerfile" ]; then
              echo "â­ï¸  Skipping $service_name (no app.py or Dockerfile)"
              continue
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐµÑÑ‚ÑŒ Ð»Ð¸ deployment Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°
            if [ ! -f "k8s/deployments/${service_name}-deployment.yaml" ]; then
              echo "ðŸ†• Found new service without manifests: $service_name"
              NEW_SERVICES="${NEW_SERVICES}\"${service_name}\","
            else
              echo "âœ… Service $service_name already has manifests"
            fi
          done
          
          # Ð£Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ
          NEW_SERVICES="${NEW_SERVICES%,}"
          
          if [ -z "$NEW_SERVICES" ]; then
            echo "âœ… No new services detected"
            echo "new_services=[]" >> $GITHUB_OUTPUT
            echo "has_new_services=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸŽ¯ New services detected!"
            JSON_ARRAY="[$NEW_SERVICES]"
            echo "new_services=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            echo "Services: $JSON_ARRAY"
          fi

  generate-manifests:
    name: ðŸ—ï¸ Generate Manifests for ${{ matrix.service }}
    needs: detect-new-services
    if: needs.detect-new-services.outputs.has_new_services == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-new-services.outputs.new_services) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Extract service configuration
        id: config
        run: |
          SERVICE_DIR="services/${{ matrix.service }}"
          
          # Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
          if [ -n "${{ github.event.inputs.port }}" ]; then
            PORT="${{ github.event.inputs.port }}"
            REPLICAS="${{ github.event.inputs.replicas }}"
          else
            # ÐÐ²Ñ‚Ð¾Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ñ€Ñ‚Ð°
            PORT=5000
            
            # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ñ€Ñ‚ Ð² Dockerfile
            if [ -f "$SERVICE_DIR/Dockerfile" ] && grep -q "EXPOSE" "$SERVICE_DIR/Dockerfile"; then
              EXPOSED_PORT=$(grep "EXPOSE" "$SERVICE_DIR/Dockerfile" | awk '{print $2}' | head -1)
              if [ -n "$EXPOSED_PORT" ]; then
                PORT=$EXPOSED_PORT
                echo "ðŸ“ Found port in Dockerfile: $PORT"
              fi
            fi
            
            # ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿Ð¾Ñ€Ñ‚ Ð² app.py
            if [ -f "$SERVICE_DIR/app.py" ] && grep -q "app.run.*port=" "$SERVICE_DIR/app.py"; then
              APP_PORT=$(grep "app.run.*port=" "$SERVICE_DIR/app.py" | grep -oP "port=\K\d+" | head -1)
              if [ -n "$APP_PORT" ]; then
                PORT=$APP_PORT
                echo "ðŸ“ Found port in app.py: $PORT"
              fi
            fi
            
            REPLICAS=2
          fi
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "replicas=$REPLICAS" >> $GITHUB_OUTPUT
          echo "ðŸ“ Configuration: Port=$PORT, Replicas=$REPLICAS"
      
      - name: Generate Kubernetes manifests
        run: |
          echo "ðŸ”§ Generating manifests for ${{ matrix.service }}..."
          
          chmod +x scripts/generate-k8s-manifests.sh
          ./scripts/generate-k8s-manifests.sh \
            ${{ matrix.service }} \
            ${{ steps.config.outputs.port }} \
            ${{ steps.config.outputs.replicas }}
      
      - name: Validate manifests with kubectl
        run: |
          echo "âœ… Validating manifests..."
          
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ kubectl ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
          if ! command -v kubectl &> /dev/null; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi
          
          # Dry-run Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸ÑÐ°
          kubectl apply --dry-run=client -f k8s/deployments/${{ matrix.service }}-deployment.yaml
          kubectl apply --dry-run=client -f k8s/services/${{ matrix.service }}-service.yaml
          kubectl apply --dry-run=client -f k8s/hpa/${{ matrix.service }}-hpa.yaml
          kubectl apply --dry-run=client -f k8s/rbac/${{ matrix.service }}-rbac.yaml
          
          echo "âœ… All manifests are valid!"
      
      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected"
            git diff --stat
          fi
      
      - name: Commit generated manifests
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add k8s/
          git commit -m "ðŸ¤– auto: generate K8s manifests for ${{ matrix.service }}

          Generated files:
          - k8s/deployments/${{ matrix.service }}-deployment.yaml
          - k8s/services/${{ matrix.service }}-service.yaml
          - k8s/hpa/${{ matrix.service }}-hpa.yaml
          - k8s/rbac/${{ matrix.service }}-rbac.yaml
          - k8s/monitoring/${{ matrix.service }}-servicemonitor.yaml
          
          Configuration:
          - Port: ${{ steps.config.outputs.port }}
          - Replicas: ${{ steps.config.outputs.replicas }}
          
          Auto-generated by GitHub Actions"
      
      - name: Push changes
        if: steps.changes.outputs.has_changes == 'true' && github.event_name != 'pull_request'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Create summary
        run: |
          echo "## ðŸ¤– Auto-Generated Manifests for \`${{ matrix.service }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`k8s/deployments/${{ matrix.service }}-deployment.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`k8s/services/${{ matrix.service }}-service.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`k8s/hpa/${{ matrix.service }}-hpa.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`k8s/rbac/${{ matrix.service }}-rbac.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… \`k8s/monitoring/${{ matrix.service }}-servicemonitor.yaml\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service Name | \`${{ matrix.service }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Port | \`${{ steps.config.outputs.port }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Replicas | \`${{ steps.config.outputs.replicas }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
            echo "### âœ… Status: Manifests generated and committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Status: No changes needed (manifests already exist)" >> $GITHUB_STEP_SUMMARY
          fi

  comment-on-pr:
    name: ðŸ’¬ Comment on PR
    needs: [detect-new-services, generate-manifests]
    if: github.event_name == 'pull_request' && needs.detect-new-services.outputs.has_new_services == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const services = ${{ needs.detect-new-services.outputs.new_services }};
            
            let comment = `## ðŸ¤– Auto-Generated Kubernetes Manifests\n\n`;
            comment += `I've automatically generated Kubernetes manifests for the following services:\n\n`;
            
            services.forEach(service => {
              comment += `### âœ… \`${service}\`\n\n`;
              comment += `Generated files:\n`;
              comment += `- \`k8s/deployments/${service}-deployment.yaml\`\n`;
              comment += `- \`k8s/services/${service}-service.yaml\`\n`;
              comment += `- \`k8s/hpa/${service}-hpa.yaml\`\n`;
              comment += `- \`k8s/rbac/${service}-rbac.yaml\`\n`;
              comment += `- \`k8s/monitoring/${service}-servicemonitor.yaml\`\n\n`;
            });
            
            comment += `\n---\n\n`;
            comment += `**Next Steps:**\n`;
            comment += `1. Review the generated manifests\n`;
            comment += `2. Make any necessary adjustments\n`;
            comment += `3. Merge this PR to apply the changes\n\n`;
            comment += `*Manifests are production-ready with:\n`;
            comment += `- âœ… Security contexts\n`;
            comment += `- âœ… Resource limits\n`;
            comment += `- âœ… Health probes\n`;
            comment += `- âœ… HPA (auto-scaling)\n`;
            comment += `- âœ… Prometheus monitoring\n`;
            comment += `- âœ… RBAC*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  summary:
    name: ðŸ“Š Summary
    needs: [detect-new-services, generate-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create final summary
        run: |
          echo "# ðŸ¤– Kubernetes Manifest Auto-Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-new-services.outputs.has_new_services }}" == "true" ]; then
            echo "## âœ… Generation Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Services processed: ${{ needs.detect-new-services.outputs.new_services }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Kubernetes manifests have been generated and validated." >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ No Action Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No new services detected that need manifest generation." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All existing services already have their manifests." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To manually generate manifests:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/generate-k8s-manifests.sh <service-name> [port] [replicas]" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
