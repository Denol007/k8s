name: ðŸš€ Microservices CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'services/**'
      - 'k8s/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'services/**'

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: denol007

jobs:
  # ============================================
  # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ°ÐºÐ¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
  # ============================================
  detect-changes:
    name: ðŸ” Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      user-service: ${{ steps.filter.outputs.user-service }}
      product-service: ${{ steps.filter.outputs.product-service }}
      order-service: ${{ steps.filter.outputs.order-service }}
      payment-service: ${{ steps.filter.outputs.payment-service }}
      any-service: ${{ steps.filter.outputs.any-service }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            user-service:
              - 'services/user-service/**'
            product-service:
              - 'services/product-service/**'
            order-service:
              - 'services/order-service/**'
            payment-service:
              - 'services/payment-service/**'
            any-service:
              - 'services/**'

  # ============================================
  # Ð›Ð¸Ð½Ñ‚Ð¸Ð½Ð³ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð°
  # ============================================
  lint:
    name: ðŸ”Ž Lint Code
    needs: detect-changes
    if: needs.detect-changes.outputs.any-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          pip install flake8 pylint black
      
      - name: Run flake8
        run: |
          flake8 services/ --max-line-length=120 --ignore=E501,W503 || true
      
      - name: Check code formatting
        run: |
          black --check services/ || true

  # ============================================
  # Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  # ============================================
  test:
    name: ðŸ§ª Run Tests
    needs: detect-changes
    if: needs.detect-changes.outputs.any-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pytest pytest-cov
          # Install dependencies for all services
          for service in services/*/; do
            if [ -f "$service/requirements.txt" ]; then
              pip install -r "$service/requirements.txt" || true
            fi
          done
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=services --cov-report=term-missing || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          fail_ci_if_error: false

  # ============================================
  # Build Ð¸ Push USER-SERVICE
  # ============================================
  build-user-service:
    name: ðŸ³ Build User Service
    needs: [detect-changes, lint, test]
    if: needs.detect-changes.outputs.user-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/user-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/user-service:latest
            ${{ env.DOCKER_USERNAME }}/user-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/user-service:latest
          format: 'table'
          exit-code: '0'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

  # ============================================
  # Build Ð¸ Push PRODUCT-SERVICE
  # ============================================
  build-product-service:
    name: ðŸ³ Build Product Service
    needs: [detect-changes, lint, test]
    if: needs.detect-changes.outputs.product-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/product-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/product-service:latest
            ${{ env.DOCKER_USERNAME }}/product-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Build Ð¸ Push ORDER-SERVICE
  # ============================================
  build-order-service:
    name: ðŸ³ Build Order Service
    needs: [detect-changes, lint, test]
    if: needs.detect-changes.outputs.order-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/order-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/order-service:latest
            ${{ env.DOCKER_USERNAME }}/order-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Build Ð¸ Push PAYMENT-SERVICE
  # ============================================
  build-payment-service:
    name: ðŸ³ Build Payment Service
    needs: [detect-changes, lint, test]
    if: needs.detect-changes.outputs.payment-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/payment-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/payment-service:latest
            ${{ env.DOCKER_USERNAME }}/payment-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Kubernetes (Ð´Ð»Ñ main Ð²ÐµÑ‚ÐºÐ¸)
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Kubernetes
    needs: 
      - detect-changes
      - build-user-service
      - build-product-service
      - build-order-service
      - build-payment-service
    if: |
      always() && 
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.any-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Ð”Ð»Ñ production Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ AWS EKS
      # Ð”Ð»Ñ dev/staging - Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÐºÐ»Ð°ÑÑ‚ÐµÑ€
      
      - name: Configure kubectl (example for AWS EKS)
        if: false  # ÐžÑ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾, Ñ‚Ð°Ðº ÐºÐ°Ðº Ñƒ Ð½Ð°Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ minikube
        run: |
          # aws eks update-kubeconfig --name microservices-cluster --region us-east-1
          echo "Skipping AWS EKS config for now"
      
      - name: Update User Service
        if: needs.detect-changes.outputs.user-service == 'true'
        run: |
          echo "Would deploy user-service with image: ${{ env.DOCKER_USERNAME }}/user-service:${{ github.sha }}"
          # kubectl set image deployment/user-service \
          #   user-service=${{ env.DOCKER_USERNAME }}/user-service:${{ github.sha }} \
          #   -n microservices
          # kubectl rollout status deployment/user-service -n microservices --timeout=5m
      
      - name: Update Product Service
        if: needs.detect-changes.outputs.product-service == 'true'
        run: |
          echo "Would deploy product-service with image: ${{ env.DOCKER_USERNAME }}/product-service:${{ github.sha }}"
      
      - name: Update Order Service
        if: needs.detect-changes.outputs.order-service == 'true'
        run: |
          echo "Would deploy order-service with image: ${{ env.DOCKER_USERNAME }}/order-service:${{ github.sha }}"
      
      - name: Update Payment Service
        if: needs.detect-changes.outputs.payment-service == 'true'
        run: |
          echo "Would deploy payment-service with image: ${{ env.DOCKER_USERNAME }}/payment-service:${{ github.sha }}"

  # ============================================
  # Smoke Tests
  # ============================================
  smoke-tests:
    name: ðŸ’¨ Smoke Tests
    needs: deploy
    if: always() && needs.deploy.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Wait for deployment
        run: |
          echo "â³ Waiting 30 seconds for deployment to stabilize..."
          sleep 30
      
      - name: Run smoke tests
        run: |
          echo "âœ… Smoke tests passed (simulated)"
          # Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð´ÐµÑÑŒ curl Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº ÑÐµÑ€Ð²Ð¸ÑÐ°Ð¼
          # curl -f http://user-service/health || exit 1

  # ============================================
  # Notifications
  # ============================================
  notify:
    name: ðŸ“¢ Send Notifications
    needs: [detect-changes, deploy, smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Success
        if: needs.deploy.result == 'success' && needs.smoke-tests.result == 'success'
        run: |
          echo "ðŸŽ‰ Deployment successful!"
          echo "Services deployed:"
          echo "  - user-service: ${{ needs.detect-changes.outputs.user-service }}"
          echo "  - product-service: ${{ needs.detect-changes.outputs.product-service }}"
          echo "  - order-service: ${{ needs.detect-changes.outputs.order-service }}"
          echo "  - payment-service: ${{ needs.detect-changes.outputs.payment-service }}"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Author: ${{ github.actor }}"
      
      - name: Deployment Failed
        if: needs.deploy.result == 'failure' || needs.smoke-tests.result == 'failure'
        run: |
          echo "âŒ Deployment failed!"
          echo "Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
      
      # Uncomment Ð´Ð»Ñ Slack ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
      # - name: Slack Notification
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: |
      #       Deployment ${{ job.status }}
      #       Commit: ${{ github.sha }}
      #       Author: ${{ github.actor }}
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  # ============================================
  # Summary
  # ============================================
  summary:
    name: ðŸ“Š Deployment Summary
    needs: [detect-changes, lint, test, deploy, smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services Changed" >> $GITHUB_STEP_SUMMARY
          echo "- User Service: ${{ needs.detect-changes.outputs.user-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- Product Service: ${{ needs.detect-changes.outputs.product-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- Order Service: ${{ needs.detect-changes.outputs.order-service }}" >> $GITHUB_STEP_SUMMARY
          echo "- Payment Service: ${{ needs.detect-changes.outputs.payment-service }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Details" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Author: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
