name: üß™ Test CI/CD Setup

# –ü—Ä–æ—Å—Ç–æ–π workflow –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –≤—Å—ë –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub Actions UI

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'

jobs:
  check-secrets:
    name: üîê Check Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check Docker Username
        run: |
          if [ -n "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "‚úÖ DOCKER_USERNAME is set"
          else
            echo "‚ùå DOCKER_USERNAME is NOT set"
            echo "Please add it in: Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
      
      - name: Check Docker Password
        run: |
          if [ -n "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "‚úÖ DOCKER_PASSWORD is set"
          else
            echo "‚ùå DOCKER_PASSWORD is NOT set"
            echo "Please add it in: Settings ‚Üí Secrets ‚Üí Actions"
            exit 1
          fi
      
      - name: Test Docker Login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          echo "‚úÖ Docker login successful!"
          docker logout
  
  test-build:
    name: üß™ Test Build (dry-run)
    runs-on: ubuntu-latest
    needs: check-secrets
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Test Build User Service (no push)
        uses: docker/build-push-action@v5
        with:
          context: services/user-service
          push: false
          tags: denol007/user-service:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Success
        run: |
          echo "‚úÖ All checks passed!"
          echo ""
          echo "Your CI/CD is ready to use:"
          echo "1. Make changes to a service"
          echo "2. git commit && git push"
          echo "3. Check Actions tab for build status"
          echo "4. Run: ./scripts/update-from-dockerhub.sh <service>"
