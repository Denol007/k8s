name: ðŸ“¦ Auto-Generate Helm Values

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    paths:
      - 'services/**'
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Service name to generate values for'
        required: false
        type: string

jobs:
  detect-new-services:
    name: ðŸ” Detect New Services Without Helm Values
    runs-on: ubuntu-latest
    outputs:
      new_services: ${{ steps.detect.outputs.new_services }}
      has_new_services: ${{ steps.detect.outputs.has_new_services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Detect new services
        id: detect
        run: |
          echo "ðŸ” Checking for services without Helm values..."
          
          # Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼
          if [ -n "${{ github.event.inputs.service_name }}" ]; then
            SERVICE_NAME="${{ github.event.inputs.service_name }}"
            echo "ðŸ“¦ Manual trigger for service: $SERVICE_NAME"
            echo "new_services=[\"$SERVICE_NAME\"]" >> $GITHUB_OUTPUT
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          NEW_SERVICES=""
          
          # ÐÐ°Ð¹Ñ‚Ð¸ Ð²ÑÐµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
          for service_dir in services/*/; do
            if [ ! -d "$service_dir" ]; then
              continue
            fi
            
            service_name=$(basename "$service_dir")
            
            # ÐŸÑ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ app.py Ð¸Ð»Ð¸ Dockerfile
            if [ ! -f "$service_dir/app.py" ] && [ ! -f "$service_dir/Dockerfile" ]; then
              echo "â­ï¸  Skipping $service_name (no app.py or Dockerfile)"
              continue
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐµÑÑ‚ÑŒ Ð»Ð¸ Helm values Ñ„Ð°Ð¹Ð»
            if [ ! -f "helm/values/${service_name}.yaml" ]; then
              echo "ðŸ†• Found service without Helm values: $service_name"
              NEW_SERVICES="${NEW_SERVICES}\"${service_name}\","
            else
              echo "âœ… Service $service_name already has Helm values"
            fi
          done
          
          # Ð£Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ
          NEW_SERVICES="${NEW_SERVICES%,}"
          
          if [ -z "$NEW_SERVICES" ]; then
            echo "âœ… No new services detected"
            echo "new_services=[]" >> $GITHUB_OUTPUT
            echo "has_new_services=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸŽ¯ New services detected!"
            JSON_ARRAY="[$NEW_SERVICES]"
            echo "new_services=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_new_services=true" >> $GITHUB_OUTPUT
            echo "Services: $JSON_ARRAY"
          fi

  generate-helm-values:
    name: ðŸ—ï¸ Generate Helm Values
    runs-on: ubuntu-latest
    needs: detect-new-services
    if: needs.detect-new-services.outputs.has_new_services == 'true'
    permissions:
      contents: write
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-new-services.outputs.new_services) }}
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Auto-detect service port
        id: detect_port
        run: |
          SERVICE="${{ matrix.service }}"
          PORT=5000
          
          # ÐŸÐ¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚ Ð¸Ð· Dockerfile
          if [ -f "services/$SERVICE/Dockerfile" ]; then
            DOCKERFILE_PORT=$(grep -E "^EXPOSE" "services/$SERVICE/Dockerfile" | awk '{print $2}' | head -1)
            if [ -n "$DOCKERFILE_PORT" ]; then
              PORT=$DOCKERFILE_PORT
              echo "âœ“ Port found in Dockerfile: $PORT"
            fi
          fi
          
          # ÐŸÐ¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ñ€Ñ‚ Ð¸Ð· app.py
          if [ -f "services/$SERVICE/app.py" ]; then
            APP_PORT=$(grep -E "port=|PORT.*=" "services/$SERVICE/app.py" | grep -oE "[0-9]{4,5}" | head -1)
            if [ -n "$APP_PORT" ]; then
              PORT=$APP_PORT
              echo "âœ“ Port found in app.py: $PORT"
            fi
          fi
          
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "ðŸ“ Using port: $PORT"
      
      - name: Generate Helm values file
        run: |
          SERVICE="${{ matrix.service }}"
          PORT="${{ steps.detect_port.outputs.port }}"
          
          mkdir -p helm/values
          
          cat > "helm/values/${SERVICE}.yaml" << EOF
          # Helm values for $SERVICE
          # Auto-generated by GitHub Actions
          
          image:
            repository: ${{ github.repository_owner }}/$SERVICE
            tag: latest
          
          service:
            port: $PORT
          
          env:
            PORT: "$PORT"
            SERVICE_NAME: "$SERVICE"
          
          fullnameOverride: "$SERVICE"
          
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐµÑ€Ð²Ð¸ÑÐ° Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:
          # configMap:
          #   enabled: true
          #   data:
          #     KEY: "value"
          
          # resources:
          #   limits:
          #     cpu: 1000m
          #     memory: 1Gi
          #   requests:
          #     cpu: 200m
          #     memory: 256Mi
          EOF
          
          echo "âœ… Generated helm/values/${SERVICE}.yaml"
          cat "helm/values/${SERVICE}.yaml"
      
      - name: Commit and push if changed
        run: |
          SERVICE="${{ matrix.service }}"
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          git add "helm/values/${SERVICE}.yaml"
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            git commit -m "chore: auto-generate Helm values for $SERVICE [skip ci]"
            git push
            echo "âœ… Pushed Helm values for $SERVICE"
          fi

  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [detect-new-services, generate-helm-values]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ¤– Helm Values Auto-Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-new-services.outputs.has_new_services }}" == "true" ]; then
            echo "âœ… **Generation Complete**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Services processed:** ${{ needs.detect-new-services.outputs.new_services }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All Helm values files have been generated." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Deploy with Helm:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "./scripts/helm-deploy.sh" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Or deploy specific service:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "helm install <service-name> ./helm/microservice -f helm/values/<service-name>.yaml -n microservices" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No New Services**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All services already have Helm values files." >> $GITHUB_STEP_SUMMARY
          fi
