name: ðŸ“¦ Build and Push on Push

# Ð­Ñ‚Ð¾Ñ‚ workflow Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð¼ push Ð² Ð»ÑŽÐ±ÑƒÑŽ Ð²ÐµÑ‚ÐºÑƒ
# ÐžÐ½ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÑ‚ Ð¸ Ð¿ÑƒÑˆÐ¸Ñ‚ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð² DockerHub

on:
  push:
    branches:
      - '**'  # Ð›ÑŽÐ±Ð°Ñ Ð²ÐµÑ‚ÐºÐ°
    paths:
      - 'services/**'

env:
  DOCKER_USERNAME: denol007

jobs:
  build-and-push:
    name: ðŸš€ Build & Push Changed Services
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ÐÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ñ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
      
      - name: Detect changed services
        id: changes
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐºÐ°ÐºÐ¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ÑÑŒ
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo ""
          
          # Ð”Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð°Ð¹Ñ‚Ð¸ Ð²ÑÐµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð½Ñ‹Ðµ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          CHANGED_SERVICES=$(echo "$CHANGED_FILES" | grep "^services/" | cut -d'/' -f2 | sort -u)
          
          echo "ðŸ” Detected changed services:"
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "  No service changes detected"
            echo "services=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "$CHANGED_SERVICES" | while read service; do
              echo "  âœ… $service"
            done
            
            # ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² JSON array
            JSON_ARRAY=$(echo "$CHANGED_SERVICES" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "services=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“¦ Services to build: $JSON_ARRAY"
          fi
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # ============================================
      # USER SERVICE
      # ============================================
      - name: ðŸ”¨ Build User Service
        if: steps.changes.outputs.user_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: services/user-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/user-service:latest
            ${{ env.DOCKER_USERNAME }}/user-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… User Service Built
        if: steps.changes.outputs.user_changed == 'true'
        run: |
          echo "âœ… user-service:latest pushed to DockerHub"
          echo "Image: ${{ env.DOCKER_USERNAME }}/user-service:latest"
      
      # ============================================
      # PRODUCT SERVICE
      # ============================================
      - name: ðŸ”¨ Build Product Service
        if: steps.changes.outputs.product_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: services/product-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/product-service:latest
            ${{ env.DOCKER_USERNAME }}/product-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Product Service Built
        if: steps.changes.outputs.product_changed == 'true'
        run: |
          echo "âœ… product-service:latest pushed to DockerHub"
      
      # ============================================
      # ORDER SERVICE
      # ============================================
      - name: ðŸ”¨ Build Order Service
        if: steps.changes.outputs.order_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: services/order-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/order-service:latest
            ${{ env.DOCKER_USERNAME }}/order-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Order Service Built
        if: steps.changes.outputs.order_changed == 'true'
        run: |
          echo "âœ… order-service:latest pushed to DockerHub"
      
      # ============================================
      # PAYMENT SERVICE
      # ============================================
      - name: ðŸ”¨ Build Payment Service
        if: steps.changes.outputs.payment_changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: services/payment-service
          push: true
          tags: |
            ${{ env.DOCKER_USERNAME }}/payment-service:latest
            ${{ env.DOCKER_USERNAME }}/payment-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: âœ… Payment Service Built
        if: steps.changes.outputs.payment_changed == 'true'
        run: |
          echo "âœ… payment-service:latest pushed to DockerHub"
      
      # ============================================
      # SUMMARY
      # ============================================
      - name: ðŸ“Š Deployment Summary
        run: |
          echo "# ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Services Built & Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changes.outputs.user_changed }}" == "true" ]; then
            echo "âœ… **user-service** â†’ \`${{ env.DOCKER_USERNAME }}/user-service:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changes.outputs.product_changed }}" == "true" ]; then
            echo "âœ… **product-service** â†’ \`${{ env.DOCKER_USERNAME }}/product-service:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changes.outputs.order_changed }}" == "true" ]; then
            echo "âœ… **order-service** â†’ \`${{ env.DOCKER_USERNAME }}/order-service:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.changes.outputs.payment_changed }}" == "true" ]; then
            echo "âœ… **payment-service** â†’ \`${{ env.DOCKER_USERNAME }}/payment-service:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐžÐ±Ñ€Ð°Ð·Ñ‹ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð² DockerHub! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾:" >> $GITHUB_STEP_SUMMARY
          echo "1. Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾: \`kubectl set image deployment/user-service user-service=${{ env.DOCKER_USERNAME }}/user-service:latest -n microservices\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Ð˜Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ: \`kubectl rollout restart deployment/user-service -n microservices\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘¤ Author: @${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
